# Opinion.trade 自动交易程序 v2.4.9

## 目录

- [文件结构](#文件结构)
- [快速开始](#快速开始)
- [配置文件](#配置文件)
- [交易模式](#交易模式)
- [分层挂单](#分层挂单)
- [做市商模式](#做市商模式)
- [常见问题](#常见问题)
- [注意事项](#注意事项)

---

## 文件结构

```
auto/
├── trade.py             # 主程序入口
├── models.py            # 数据模型（配置类、状态类）
├── display.py           # 显示模块（表格、盘口显示）
├── services.py          # 服务模块（订单簿、订单构建等）
├── websocket_client.py  # WebSocket 实时数据
├── __init__.py          # 模块导出
├── requirements.txt     # 依赖列表
├── trader_configs.txt   # 账户配置文件
├── proxy_cache.json     # 代理地址缓存（自动生成）
├── install.sh           # 一键安装脚本
├── run.sh               # 前台运行脚本
├── run_background.sh    # 后台运行脚本
├── stop.sh              # 停止程序脚本
├── status.sh            # 查看状态脚本
├── logs.sh              # 查看日志脚本
├── logs/                # 日志目录（自动创建）
└── wallet/              # 钱包工具目录
    ├── wallet.py        # 助记词转EVM地址工具
    └── README.md        # 钱包工具说明
```

---

## 快速开始

### 1. 安装

```bash
chmod +x install.sh
./install.sh
```

### 2. 配置账户

编辑 `trader_configs.txt`，格式支持 `|`、空格、Tab 分隔（可混合）：

```
# 新格式（推荐）- 代理地址自动获取
备注|API_KEY|EOA地址|私钥|SOCKS5代理(可选)

# 示例
账户1|your_api_key|0xEOA地址|0x私钥|127.0.0.1:1080:user:pass
账户2	api_key2	0xEOA地址2	0x私钥2
```

### 3. 运行

```bash
./run.sh              # 前台交互模式
./run_background.sh   # 后台运行（做市商推荐）
./stop.sh             # 停止程序
./status.sh           # 查看状态
./logs.sh             # 查看日志
```

---

## 配置文件

### 配置格式

| 字段 | 必填 | 说明 |
|------|------|------|
| 备注 | 是 | 账户名称，用于显示 |
| api_key | 是 | Opinion.trade API Key |
| EOA地址 | 是 | 钱包地址 (0x开头) |
| 私钥 | 是 | 钱包私钥 (0x开头) |
| socks5代理 | 否 | 代理地址 |

### 代理格式

```
# 无认证
127.0.0.1:1080

# 带认证
127.0.0.1:1080:username:password
```

---

## 交易模式

### 主菜单

```
1. 仅买入
2. 仅卖出
3. 先买后卖
4. 先卖后买
5. 自定义策略
6. 快速模式（买卖交替）
7. 低损耗模式（先买后挂单）
8. 挂单模式（自定义价格）
9. 做市商模式（双边挂单+分层）
10. 增强买卖（按金额/仓位+交易汇总）
```

### 仅买入

适用场景：看涨时批量建仓

流程：
1. 选择市场
2. 选择 YES/NO
3. 选择账户
4. 设置金额范围
5. 设置交易次数
6. 选择策略（限价单/市价单/分层挂单）

### 仅卖出

适用场景：清仓或分批出货

支持两种范围：
- 卖出指定市场持仓
- 卖出所有持仓（多市场）

### 先买后卖 / 先卖后买

适用场景：刷交易量

每轮包含买入+卖出各一次

---

## 分层挂单

### 功能说明

分层挂单可以将一笔大订单拆分成多个小订单，分散到不同价格档位，增加成交概率和隐蔽性。

### 使用方法

在"仅买入"或"仅卖出"模式中，选择策略时选择 **3. 分层挂单**：

```
卖出策略:
1. 限价单 (单档价格)
2. 市价单 (立即成交)
3. 分层挂单 (多档价格分散)  ← 选择这个
```

### 配置流程

#### 第一步：价格选择方式

```
[1] 价格选择方式:
  1. 按盘口档位 (如 买1-买3-买5 或 卖1-卖3-卖5)
  2. 自定义价格区间 (指定起始价、结束价、层数)
  3. 自定义价格列表 (如: 60 62 65 70)
```

**方式1 - 按盘口档位**

系统显示当前盘口，输入档位数字（空格分隔）：

```
当前卖出盘口:
   1. 卖1 55.00¢  (深度: 1000)
   2. 卖2 55.50¢  (深度: 500)
   3. 卖3 56.00¢  (深度: 300)
   ...

输入档位，用空格分隔 (如: 1 3 5 表示卖1、卖3、卖5)
请输入档位 (默认: 1 3 5): 1 3 5
```

**方式2 - 自定义价格区间**

```
起始价格 (分): 55
结束价格 (分): 60
分层数量 (2-10): 5

✓ 价格层级: 55.00¢, 56.25¢, 57.50¢, 58.75¢, 60.00¢
```

**方式3 - 自定义价格列表**

直接输入不连续的价格（空格分隔）：

```
输入价格列表，用空格分隔 (单位: 分)
示例: 60 62 65 70 表示在 60¢、62¢、65¢、70¢ 四个价格挂单
请输入价格: 60 62 65 70

✓ 价格层级: 60.00¢, 62.00¢, 65.00¢, 70.00¢
```

#### 第二步：金额分布模式

```
[2] 金额分布模式:
  1. 均匀分布 (每层金额相等)
  2. 金字塔 (靠近盘口少，远离盘口多)
  3. 倒金字塔 (靠近盘口多，远离盘口少)
  4. 自定义比例
```

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| 均匀分布 | 每层金额/份额相等 | 通用 |
| 金字塔 | 近盘口少，远盘口多 | 预期价格会继续移动 |
| 倒金字塔 | 近盘口多，远盘口少 | 希望快速成交 |
| 自定义 | 手动设置各层比例 | 精细控制 |

**自定义比例示例**

```
输入各层比例，用空格分隔 (需要3个数字)
示例: 1 2 3 表示第一层占1份，第二层占2份，第三层占3份
请输入比例: 5 3 2

结果: 第一层50%, 第二层30%, 第三层20%
```

#### 第三步：确认预览

```
分层预览:
  第1层: 55.00¢ - 占比 50.0%
  第2层: 56.00¢ - 占比 33.3%
  第3层: 57.00¢ - 占比 16.7%

确认配置? (y/n, 默认y): y
```

### 执行结果

```
执行分层卖出挂单 (总份额: 1000)...
    ✓ 第1层: 500份 @ 55.00¢
    ✓ 第2层: 333份 @ 56.00¢
    ✓ 第3层: 167份 @ 57.00¢
  分层卖出完成: 成功3笔, 失败0笔
```

---

## 做市商模式

### 功能特点

- 双边挂单（买卖同时）
- 自动跟随盘口调价
- 成本加成定价
- 分层挂单
- 网格策略
- 止损保护
- 深度骤降保护

### 配置参数

#### 基础参数

| 参数 | 说明 | 建议值 |
|------|------|--------|
| 最小价差阈值 | 价差小于此值暂停跟随 | 0.5-1.0 |
| 价格调整步长 | 每次调价幅度 | 0.1 |
| 单笔金额范围 | 最小-最大金额 | 5-20 |
| 检查间隔 | 盘口检查频率(秒) | 2-5 |

#### 价格边界保护

| 参数 | 说明 |
|------|------|
| max_buy_price | 买入价格上限（硬性） |
| min_sell_price | 卖出价格下限（硬性） |
| max_price_deviation | 相对启动价的最大偏离 |

#### 仓位限制（至少设置一项）

| 参数 | 说明 |
|------|------|
| max_position_shares | 最大持仓份额 |
| max_position_amount | 最大持仓金额($) |
| max_position_percent | 最大持仓占净资产% |

#### 止损设置（三选一）

| 参数 | 说明 |
|------|------|
| stop_loss_percent | 亏损百分比止损 |
| stop_loss_amount | 亏损金额止损($) |
| stop_loss_price | 价格止损(分) |

### 成本加成卖出

启用后，卖单价格根据买入成本计算，不再跟随市场下跌：

```
卖出价 = 平均买入成本 + 利润价差
```

配置参数：
- `cost_based_sell_enabled`: 是否启用
- `sell_profit_spread`: 利润价差（分）
- `min_cost_profit_spread`: 最小利润价差

适用场景：
- 避免被动跟随下跌
- 确保每笔卖出都有利润

### 网格策略

追踪每笔买入成本，自动按 `买入价 + 利润价差` 挂卖单：

```
买入 @ 50¢ → 挂卖 @ 51¢
买入 @ 49¢ → 挂卖 @ 50¢
买入 @ 48¢ → 挂卖 @ 49¢
```

配置参数：
- `grid_profit_spread`: 目标利润价差
- `grid_levels`: 网格层数
- `grid_level_spread`: 层间价格间距
- `grid_amount_per_level`: 每层金额

---

## 常见问题

### Q: 代理地址从哪里获取？

A: 代理地址**自动从 API 获取**，无需手动填写。

**缓存机制**（v2.4.3+）：
- 首次获取后自动保存到 `proxy_cache.json`
- 下次启动直接从缓存读取，无需重复请求 API
- 新增账户会自动获取并追加到缓存

**手动清除缓存**：删除 `proxy_cache.json` 文件即可强制重新获取。

### Q: 配置文件报错"格式不正确"？

A: 检查：
1. 字段数量是否足够（至少4个：备注、api_key、EOA、私钥）
2. EOA地址和私钥是否以 `0x` 开头
3. 分隔符使用 `|`、空格或 Tab

### Q: 分层挂单和普通限价单有什么区别？

A:
- **普通限价单**：所有金额挂在同一价格
- **分层挂单**：金额分散到多个价格档位

分层挂单优势：
- 增加成交概率
- 降低单点滑点
- 更隐蔽

### Q: 做市商模式如何防止亏损？

A: 设置以下保护：
1. **价格边界**：设置买入上限和卖出下限
2. **仓位限制**：控制最大持仓
3. **止损**：达到亏损阈值自动停止
4. **深度保护**：盘口深度骤降时自动撤单

### Q: 后台运行时如何查看状态？

A:
```bash
./status.sh           # 查看进程状态
./logs.sh             # 查看最新日志
tail -f logs/*.log    # 实时跟踪日志
```

### Q: 如何安全停止程序？

A:
- 前台运行：按 `Ctrl+C`
- 后台运行：执行 `./stop.sh`

---

## 注意事项

1. 请确保账户有足够余额
2. 做市商长期运行建议使用后台模式 `./run_background.sh`
3. 前台运行时使用 Ctrl+C 可安全停止
4. 后台运行时使用 `./stop.sh` 停止
5. 建议先用小金额测试
6. 定期检查日志确认运行状态

---

## 日志说明

后台运行时，所有输出都会记录到日志文件：

```
logs/
├── trader_20250104_120000.log  # 日志文件（按启动时间命名）
├── trader_20250104_150000.log
└── trader.pid                   # 当前运行的进程ID
```

### 查看日志

```bash
# 实时查看最新日志
tail -f logs/trader_*.log

# 查看最近100行
tail -100 logs/trader_*.log

# 搜索关键词（如账户名、成交、止损等）
grep "成交" logs/trader_*.log
grep "止损" logs/trader_*.log
grep "账户1" logs/trader_*.log

# 使用日志查看工具
./logs.sh
```

---

## 风险提示

1. 加密货币交易有风险，请谨慎操作
2. 做市商策略可能导致单边持仓亏损
3. 建议先用小金额测试
4. 本软件不保证盈利，所有损失由用户自行承担

---

## 版权声明

本软件受版权保护，仅授权给指定用户个人使用。

严禁以下行为：
1. 通过互联网或其他方式传播、复制、转发本软件
2. 出售、出租或以任何形式交易本软件
3. 未经授权进行以盈利为目的的二次开发
4. 将本软件提供给未经授权的第三方使用

违反上述条款将承担相应的法律责任。
